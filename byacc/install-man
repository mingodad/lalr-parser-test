#!/bin/sh
# generated by CF_INSTALL_MAN

LANG=C;     export LANG
LC_ALL=C;   export LC_ALL
LC_CTYPE=C; export LC_CTYPE
LANGUAGE=C; export LANGUAGE

INSTALL="/usr/bin/install -c"
INSTALL_DATA="${INSTALL} -m 644"

usage() {
	cat <<EOF
Usage: install-man [-l] [source] target
EOF
	exit 1
}

failed() {
	echo "?? $*" >&2
	exit 1
}

test $# != 0 || usage
OPTS=
case "x$1" in
(x-l)
	OPTS="link"
	shift
	;;
(x-*)
	usage
	;;
esac

source=
if test $# = 2 ; then
	source=$1; shift
	target=$1
elif test $# = 1 ; then
	test -n "$OPTS" && usage
	target=$1
else
	usage
fi

origin_name=`echo "$source" |sed -e 's%^.*/%%' -e 's%\..*%%'`
actual_name=`echo "$origin_name" |sed 's,x,x,'`
leading_cap=`echo "$actual_name" | sed -e 's%^\(.\).*$%\1%' | tr a-z A-Z``echo "$actual_name" | sed -e 's%^.%%'`
capitalized=`echo "$actual_name" | tr a-z A-Z`

cf_tmpdir=`mktemp -d`
trap 'rm -rf "$cf_tmpdir"; exit 1' 1 2 3 15
trap 'rm -rf "$cf_tmpdir"; exit 0' 0

if test -n "$source" ; then
	suffix=
	test -n "@cf_manpage_so_strip" && suffix="."
	if test "x$OPTS" = xlink ; then
		source_dir=`echo "$source" | sed -e "s%/[^/]*$%%"`
		target_dir=`echo "$target" | sed -e "s%/[^/]*$%%"`
		sourcelink="${source}${suffix}"
		targetfile="${target}${suffix}"
		targetlink="${target_dir}/${sourcelink}"
		if test ! -d "$target_dir" ; then
			failed "target directory does not exist: $target_dir"
		elif test ! -f "$targetfile" ; then
			failed "target file does not exist: $targetfile"
		elif test "$source" != "$source_dir" ; then
			failed "unexpected directory for source-link: $source_dir"
		fi
		test -f "$targetlink" && failed "already exists $targetlink"
		( cd "$target_dir" && ln -s "`echo "$targetfile" | sed -e 's%^.*/%%'`" "$sourcelink" )
		test -f "$targetlink" || failed "cannot create $targetlink"
		target="$targetlink"
	else
		echo "** installing $source to $target"
		interim="$cf_tmpdir"/"`basename $source`"
		if test "x$origin_name" != "x$actual_name" ; then
			sed \
				-e "/^.ds N/s%N.*%N $leading_cap%" \
				-e "/^.ds n/s%n.*%n $actual_name%" \
				-e "/^\.TH/s%[ ][ ]*[^ ][^ ]*% $capitalized%" \
				-e "/^\.SH[ ][ ]*NAME/,/[ ]\\\\-[ ]/s%^\\\\\\*[Nn]%$actual_name%" \
				"$source" >"$interim" || exit 1
			diff -c "$source" "$interim"
		else
			cp "$source" "$interim" || exit 1
		fi
		if test -n "" ; then
			 "$interim"
			source="${interim}${suffix}"
		fi
		if test -d "$target" ; then
			target="$target"/"$source"
		else
			test -n "" && target="${target}."
		fi
		$INSTALL_DATA "$source" "$target" || exit 1
	fi
	echo "...installed $target"
else
	echo "** removing $target"
	test -n "" && target="${target}."
	if test -f "$target" ; then
		rm -f "$target"
		echo "...removed $target"
	else
		echo "...not found"
	fi
fi
exit 0
